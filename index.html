<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ TEST - Conexi√≥n Google Sheets</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2596be;
            border-bottom: 3px solid #2596be;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-weight: bold;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .data-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        button {
            background: #2596be;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1e7a9e;
        }
        .instruction {
            background: #e7f3ff;
            padding: 15px;
            border-left: 4px solid #2596be;
            margin: 20px 0;
        }
        .logs {
            background: #000;
            color: #0f0;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ TEST DE CONEXI√ìN - Google Sheets Hoja 2</h1>
        
        <div class="instruction">
            <strong>üìã Instrucciones:</strong>
            <ol>
                <li>Aseg√∫rate de que tu Google Sheet sea <strong>P√öBLICA</strong></li>
                <li>Haz click en "üîÑ Probar Conexi√≥n"</li>
                <li>Mira los logs abajo para ver qu√© sucede</li>
                <li>Si funciona, ver√°s tus textos de la Hoja 2</li>
            </ol>
        </div>

        <div id="status" class="status loading">
            ‚è≥ Esperando... Click en el bot√≥n para probar
        </div>

        <button onclick="testConnection()">üîÑ Probar Conexi√≥n</button>
        <button onclick="clearLogs()">üóëÔ∏è Limpiar Logs</button>

        <h2>üìä Datos Encontrados:</h2>
        <div id="results"></div>

        <h2>üìù Logs de Consola:</h2>
        <div id="logs" class="logs">Logs aparecer√°n aqu√≠...<br><br></div>
    </div>

    <script>
        const SHEET_ID = '1kLfQOZnTsBJ8lRXA0ab5RXk-QM3VeSRkDQsatL3-tVk';
        let logsDiv = document.getElementById('logs');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#0f0',
                'success': '#0f0',
                'error': '#f00',
                'warning': '#ff0'
            };
            const color = colors[type] || '#0f0';
            logsDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('status').className = 'status loading';
            document.getElementById('status').textContent = '‚è≥ Logs limpiados. Click en el bot√≥n para probar';
        }

        function parseCSVLine(line, delimiter = ',') {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === delimiter && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        async function testConnection() {
            clearLogs();
            log('üöÄ Iniciando test de conexi√≥n...', 'info');
            log(`üì° Google Sheet ID: ${SHEET_ID}`, 'info');
            log(`üéØ gid de tu Hoja 2: 514707142`, 'info');
            
            document.getElementById('status').className = 'status loading';
            document.getElementById('status').textContent = '‚è≥ Probando conexi√≥n...';

            // gid=514707142 es tu Hoja 2 (del URL que compartiste)
            const gidsToTry = [514707142, 0, 1, 2, 3]; // Prueba primero el correcto
            
            for (const gid of gidsToTry) {
                const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
                
                log(`\nüîç Probando gid=${gid}...`, 'info');
                log(`üì° URL: ${CSV_URL}`, 'info');
                
                try {
                    const response = await fetch(CSV_URL);
                    
                    if (!response.ok) {
                        log(`‚ùå gid=${gid} fall√≥: ${response.status} ${response.statusText}`, 'error');
                        continue;
                    }
                    
                    const csvText = await response.text();
                    log(`‚úÖ Respuesta recibida (${csvText.length} caracteres)`, 'success');
                    log(`üìÑ Primeros 300 caracteres:\n${csvText.substring(0, 300)}`, 'info');
                    
                    const lines = csvText.split('\n').filter(line => line.trim().length > 0);
                    log(`üìä Total de l√≠neas: ${lines.length}`, 'info');
                    
                    if (lines.length < 1) {
                        log(`‚ö†Ô∏è gid=${gid}: Hoja vac√≠a`, 'warning');
                        continue;
                    }
                    
                    const delimiter = lines[0].includes(';') ? ';' : ',';
                    log(`üîç Delimitador detectado: ${delimiter === ';' ? 'punto y coma (;)' : 'coma (,)'}`, 'info');
                    
                    const allRows = lines.map(line => parseCSVLine(line, delimiter));
                    
                    log(`\nüìã CONTENIDO DE LA HOJA (gid=${gid}):`, 'info');
                    allRows.forEach((row, idx) => {
                        log(`   Fila ${idx + 1}: [${row.length} columnas]`, 'info');
                        row.forEach((cell, cellIdx) => {
                            const preview = cell.length > 60 ? cell.substring(0, 60) + '...' : cell;
                            log(`      Columna ${String.fromCharCode(65 + cellIdx)}: ${preview}`, 'info');
                        });
                    });
                    
                    // Buscar fila con datos
                    let dataRow = -1;
                    for (let i = 0; i < allRows.length; i++) {
                        const row = allRows[i];
                        if (row[0] && row[0].length > 20 && row[1] && row[1].length > 20) {
                            dataRow = i;
                            break;
                        }
                    }
                    
                    if (dataRow >= 0) {
                        log(`\nüéØ ¬°DATOS ENCONTRADOS EN FILA ${dataRow + 1}!`, 'success');
                        
                        const data = allRows[dataRow];
                        const textoComercial = (data[0] || '').replace(/"/g, '');
                        const condicionesIntro = (data[1] || '').replace(/"/g, '');
                        const condicionesRaw = (data[2] || '').replace(/"/g, '');
                        const condicionesPuntos = condicionesRaw.split(/[;\n]/).map(c => c.trim()).filter(c => c.length > 5);
                        
                        document.getElementById('status').className = 'status success';
                        document.getElementById('status').textContent = `‚úÖ ¬°CONEXI√ìN EXITOSA! Datos encontrados en gid=${gid}`;
                        
                        let resultsHTML = `
                            <div class="data-box">
                                <strong>üìç Encontrado en: gid=${gid}, Fila ${dataRow + 1}</strong><br><br>
                                
                                <strong>1Ô∏è‚É£ TEXTO COMERCIAL (Columna A):</strong><br>
                                ${textoComercial}<br><br>
                                
                                <strong>2Ô∏è‚É£ CONDICIONES INTRO (Columna B):</strong><br>
                                ${condicionesIntro}<br><br>
                                
                                <strong>3Ô∏è‚É£ CONDICIONES PUNTOS (Columna C):</strong><br>
                                ${condicionesPuntos.map((p, i) => `${i+1}. ${p}`).join('<br>')}
                            </div>
                        `;
                        
                        document.getElementById('results').innerHTML = resultsHTML;
                        
                        log(`\n‚úÖ RESUMEN:`, 'success');
                        log(`   - Texto comercial: ${textoComercial.length} caracteres`, 'success');
                        log(`   - Condiciones intro: ${condicionesIntro.length} caracteres`, 'success');
                        log(`   - Condiciones puntos: ${condicionesPuntos.length} encontrados`, 'success');
                        log(`\nüéâ ¬°TEST COMPLETADO CON √âXITO!`, 'success');
                        log(`üí° Los textos se cargar√°n autom√°ticamente en tu panel`, 'info');
                        
                        return; // √âxito, salir
                    } else {
                        log(`‚ö†Ô∏è gid=${gid}: No se encontraron datos v√°lidos (textos muy cortos)`, 'warning');
                    }
                    
                } catch (error) {
                    log(`‚ùå Error con gid=${gid}: ${error.message}`, 'error');
                }
            }
            
            // Si llegamos aqu√≠, ning√∫n gid funcion√≥
            log(`\n‚ùå ERROR: No se pudo cargar la Hoja 2 con ning√∫n gid`, 'error');
            log(`\nüîß SOLUCIONES:`, 'warning');
            log(`1. Verifica que la hoja sea P√öBLICA`, 'warning');
            log(`2. Ve a: Compartir > Acceso general > Cualquier persona con el enlace`, 'warning');
            log(`3. Aseg√∫rate de que haya datos en la Hoja 2 (no solo encabezados)`, 'warning');
            log(`4. Verifica que los textos tengan al menos 20 caracteres`, 'warning');
            
            document.getElementById('status').className = 'status error';
            document.getElementById('status').textContent = '‚ùå No se pudo conectar. Lee los logs arriba.';
        }
    </script>
</body>
</html>
